name: Teardown Preview Deployment

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Pull Request Number'
        required: true
      commit_sha:
        description: 'Commit SHA'
        required: true

permissions:
  contents: write

jobs:
  teardown:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '16'

      - name: Teardown Preview
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.inputs.pr_number }}
          COMMIT_SHA=${{ github.event.inputs.commit_sha }}
          DEPLOY_DIR="pr-${PR_NUMBER}-${COMMIT_SHA}"

          # Configure git
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

          # Fetch gh-pages branch
          git fetch origin gh-pages:gh-pages

          # Clone the existing gh-pages branch
          git clone --branch=gh-pages https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/saichandras/saichandras.github.io.git gh-pages
          cd gh-pages

          # Remove the directory for this PR
          rm -rf ${DEPLOY_DIR}

          # Commit and push the changes
          git add .
          git commit -m "Teardown preview for PR #${PR_NUMBER} - ${COMMIT_SHA}"
          git push origin gh-pages
